name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # 当推送类似 v1.0.0 的标签时触发
  workflow_dispatch:  # 允许手动触发

env:
  CARGO_TERM_COLOR: always

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        targets: x86_64-pc-windows-msvc

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache target directory
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-target-${{ hashFiles('**/Cargo.lock') }}

    - name: Build CLI (Release)
      run: cargo build --release --bin smart-recorder

    - name: Build GUI (Release)
      run: cargo build --release --bin smart-recorder-gui

    - name: Prepare release artifacts
      shell: powershell
      run: |
        New-Item -ItemType Directory -Force -Path release
        Copy-Item target\release\smart-recorder.exe release\
        Copy-Item target\release\smart-recorder-gui.exe release\
        Copy-Item README.md release\
        
        # 创建配置文件示例
        @"
        {
          "output_path": "D:\\Recordings",
          "auto_create_folders": true,
          "sample_rate": 48000,
          "bit_rate": 128,
          "audio_format": "mp3",
          "mp3_quality": 2,
          "mic_gain": 1.0,
          "speaker_gain": 1.0,
          "blacklist": "chrome.exe,firefox.exe,msedge.exe,explorer.exe",
          "auto_start": false,
          "minimize_to_tray": true,
          "min_duration_seconds": 3
        }
        "@ | Out-File -FilePath release\config.example.json -Encoding UTF8

    - name: Create ZIP archive
      shell: powershell
      run: |
        $version = "${{ github.ref_name }}"
        if ($version -notmatch "^v") {
          $version = "v1.0.0"
        }
        Compress-Archive -Path release\* -DestinationPath "smart-recorder-windows-$version.zip"

    - name: Get version from tag
      id: get_version
      shell: bash
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=v1.0.0" >> $GITHUB_OUTPUT
        fi

    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          smart-recorder-windows-*.zip
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## Smart Recorder ${{ steps.get_version.outputs.VERSION }}
          
          ### 新功能
          - ✅ 智能麦克风检测和自动录音
          - ✅ 手动录音功能
          - ✅ 可配置采样频率 (16kHz - 96kHz)
          - ✅ 可配置比特率 (64 - 320 kbps)
          - ✅ MP3 编码质量设置 (0-9)
          - ✅ 双通道录音 (麦克风 + 扬声器)
          - ✅ 进程黑名单功能
          - ✅ 实时音频电平监控
          - ✅ MP3 和 WAV 格式支持
          
          ### 下载说明
          - 下载 `smart-recorder-windows-*.zip` 文件
          - 解压到任意目录
          - 运行 `smart-recorder-gui.exe` 启动图形界面
          - 或运行 `smart-recorder.exe` 使用命令行版本
          
          ### 系统要求
          - Windows 10/11 (64-bit)
          - .NET Framework (通常已预装)
          
          ### 配置文件
          首次运行后会在程序目录下生成 `smart_recorder_config.json` 配置文件
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: smart-recorder-windows
        path: smart-recorder-windows-*.zip
        retention-days: 30
