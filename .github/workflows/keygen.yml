name: Advanced Build and Cache

on:
  push:
    branches: [ main, master, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'Release'
        type: choice
        options:
          - Debug
          - Release

env:
  PROJECT_NAME: WeChatRecorder
  SOLUTION_FILE: WeChatRecorder.sln

jobs:
  build:
    name: Build ${{ matrix.platform }} - ${{ matrix.configuration }}
    runs-on: windows-latest
    
    strategy:
      matrix:
        platform: [x64, x86]
        configuration: [Release, Debug]
        exclude:
          # 排除 x86 Debug 以节省时间
          - platform: x86
            configuration: Debug
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v2
      with:
        vs-version: latest
        
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2
      
    - name: Setup Visual Studio Developer Environment
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: ${{ matrix.platform }}
        
    - name: Fix resource files encoding issues
      run: |
        Write-Host "===== Checking and Fixing Resource Files =====" -ForegroundColor Cyan
        
        # 查找所有 .h 和 .rc 文件
        $filesToCheck = Get-ChildItem -Path "WeChatRecorder" -Include "*.h","*.rc" -Recurse
        
        foreach ($file in $filesToCheck) {
          # 检查文件是否以换行符结束
          $content = Get-Content $file.FullName -Raw
          
          if ($content -and -not $content.EndsWith("`n")) {
            Write-Host "  ⚠ Fixing: $($file.Name) (missing final newline)" -ForegroundColor Yellow
            
            # 添加最后的换行符
            Add-Content -Path $file.FullName -Value "" -NoNewline
            $content = $content + "`n"
            Set-Content -Path $file.FullName -Value $content -NoNewline
            
            Write-Host "  ✓ Fixed: $($file.Name)" -ForegroundColor Green
          } else {
            Write-Host "  ✓ OK: $($file.Name)" -ForegroundColor Green
          }
        }
        
        Write-Host "=============================================" -ForegroundColor Cyan
      shell: pwsh
        
    - name: Detect and Configure Windows SDK
      id: sdk_setup
      run: |
        # 查找已安装的 Windows SDK
        $sdkPath = "C:\Program Files (x86)\Windows Kits\10\Include"
        $availableSDKs = @()
        
        if (Test-Path $sdkPath) {
          $availableSDKs = Get-ChildItem $sdkPath -Directory | 
                          Sort-Object Name -Descending | 
                          Select-Object -ExpandProperty Name
        }
        
        if ($availableSDKs.Count -eq 0) {
          Write-Error "No Windows SDK found!"
          exit 1
        }
        
        $latestSDK = $availableSDKs[0]
        Write-Host "===== Windows SDK Detection =====" -ForegroundColor Cyan
        Write-Host "Available SDK versions:" -ForegroundColor Green
        $availableSDKs | ForEach-Object { Write-Host "  - $_" }
        Write-Host "`nUsing latest SDK: $latestSDK" -ForegroundColor Green
        Write-Host "=================================" -ForegroundColor Cyan
        
        echo "SDK_VERSION=$latestSDK" >> $env:GITHUB_OUTPUT
        echo "WINDOWS_SDK_VERSION=$latestSDK" >> $env:GITHUB_ENV
      shell: pwsh
      
    - name: Update project files to use available SDK
      run: |
        # 更新 .vcxproj 文件中的 WindowsTargetPlatformVersion
        $projectFile = "WeChatRecorder\WeChatRecorder.vcxproj"
        
        if (Test-Path $projectFile) {
          $content = Get-Content $projectFile -Raw
          
          # 替换 WindowsTargetPlatformVersion
          $newContent = $content -replace '<WindowsTargetPlatformVersion>[\d\.]+</WindowsTargetPlatformVersion>', 
                                         "<WindowsTargetPlatformVersion>${{ steps.sdk_setup.outputs.SDK_VERSION }}</WindowsTargetPlatformVersion>"
          
          $newContent | Set-Content $projectFile -NoNewline
          
          Write-Host "✓ Updated project file to use SDK: ${{ steps.sdk_setup.outputs.SDK_VERSION }}" -ForegroundColor Green
        } else {
          Write-Warning "Project file not found at: $projectFile"
        }
      shell: pwsh
      
    - name: Restore NuGet packages
      run: nuget restore ${{ env.SOLUTION_FILE }}
      
    - name: Get version information
      id: version
      run: |
        # 获取版本号
        if ("${{ github.ref }}" -match "refs/tags/v(.+)") {
          $version = $matches[1]
        } else {
          $version = (Get-Date -Format "yyyy.MM.dd.HHmm")
        }
        
        # 获取提交信息
        $commitShort = "${{ github.sha }}".Substring(0,7)
        $commitMsg = git log -1 --pretty=%B
        
        # 输出变量
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "commit=$commitShort" >> $env:GITHUB_OUTPUT
        echo "commit_msg=$commitMsg" >> $env:GITHUB_OUTPUT
        
        Write-Host "Version: $version"
        Write-Host "Commit: $commitShort"
      shell: pwsh
      
    - name: Build solution
      run: |
        # 将 x86 映射到 Win32（MSBuild 标准）
        $platform = "${{ matrix.platform }}"
        if ($platform -eq "x86") {
          $platform = "Win32"
        }
        
        Write-Host "===== Build Configuration =====" -ForegroundColor Cyan
        Write-Host "Configuration: ${{ matrix.configuration }}"
        Write-Host "Platform: $platform"
        Write-Host "Windows SDK: ${{ steps.sdk_setup.outputs.SDK_VERSION }}"
        Write-Host "Solution: ${{ env.SOLUTION_FILE }}"
        Write-Host "===============================" -ForegroundColor Cyan
        
        msbuild ${{ env.SOLUTION_FILE }} `
          /p:Configuration=${{ matrix.configuration }} `
          /p:Platform=$platform `
          /p:WindowsTargetPlatformVersion=${{ steps.sdk_setup.outputs.SDK_VERSION }} `
          /p:PlatformToolset=v143 `
          /m `
          /v:minimal `
          /p:UseMultiToolTask=true `
          /p:CL_MPCount=2
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "`n===== Build Failed =====" -ForegroundColor Red
          Write-Error "Build failed with exit code $LASTEXITCODE"
          exit $LASTEXITCODE
        }
        
        Write-Host "`n✓ Build completed successfully!" -ForegroundColor Green
      shell: pwsh
      
    - name: Locate and verify build output
      id: locate_output
      run: |
        # 查找生成的 EXE 文件
        $config = "${{ matrix.configuration }}"
        
        # 可能的输出路径（按优先级）
        $possiblePaths = @(
          "WeChatRecorder\x64\$config\${{ env.PROJECT_NAME }}.exe",
          "WeChatRecorder\Win32\$config\${{ env.PROJECT_NAME }}.exe",
          "WeChatRecorder\${{ matrix.platform }}\$config\${{ env.PROJECT_NAME }}.exe",
          "x64\$config\${{ env.PROJECT_NAME }}.exe",
          "Win32\$config\${{ env.PROJECT_NAME }}.exe",
          "${{ matrix.platform }}\$config\${{ env.PROJECT_NAME }}.exe"
        )
        
        Write-Host "===== Searching for Build Output =====" -ForegroundColor Yellow
        
        $exePath = $null
        foreach ($path in $possiblePaths) {
          Write-Host "  Checking: $path"
          if (Test-Path $path) {
            $exePath = $path
            Write-Host "  ✓ Found!" -ForegroundColor Green
            break
          }
        }
        
        if (-not $exePath) {
          Write-Host "`n⚠ Build output not found in expected locations!" -ForegroundColor Yellow
          Write-Host "Searching entire workspace..."
          
          $foundExes = Get-ChildItem -Path . -Filter "${{ env.PROJECT_NAME }}.exe" -Recurse -ErrorAction SilentlyContinue
          
          if ($foundExes) {
            Write-Host "`nFound EXE files:"
            $foundExes | ForEach-Object { 
              Write-Host "  - $($_.FullName)" -ForegroundColor Cyan
              if (-not $exePath) {
                $exePath = $_.FullName
              }
            }
          } else {
            Write-Error "✗ No build output found anywhere!"
            exit 1
          }
        }
        
        # 获取文件信息
        $fileInfo = Get-Item $exePath
        Write-Host "`n===== Build Output =====" -ForegroundColor Green
        Write-Host "File: $exePath"
        Write-Host "Size: $([math]::Round($fileInfo.Length / 1KB, 2)) KB"
        Write-Host "Modified: $($fileInfo.LastWriteTime)"
        Write-Host "========================" -ForegroundColor Green
        
        # 保存输出路径
        $outputDir = Split-Path $exePath -Parent
        echo "output_dir=$outputDir" >> $env:GITHUB_OUTPUT
        echo "exe_path=$exePath" >> $env:GITHUB_OUTPUT
      shell: pwsh
      
    - name: Organize build artifacts
      run: |
        $sourceDir = "${{ steps.locate_output.outputs.output_dir }}"
        $destDir = "build\${{ matrix.platform }}\${{ matrix.configuration }}"
        
        # 创建目标目录
        New-Item -ItemType Directory -Force -Path $destDir | Out-Null
        
        # 复制所有构建产物
        Write-Host "===== Organizing Build Artifacts =====" -ForegroundColor Cyan
        Write-Host "Source: $sourceDir"
        Write-Host "Destination: $destDir"
        
        Copy-Item -Path "$sourceDir\*" -Destination $destDir -Recurse -Force
        
        # 列出文件
        Write-Host "`nBuild artifacts:"
        Get-ChildItem $destDir -File | ForEach-Object {
          $sizeKB = [math]::Round($_.Length / 1KB, 2)
          Write-Host "  ✓ $($_.Name) ($sizeKB KB)" -ForegroundColor Green
        }
        Write-Host "======================================" -ForegroundColor Cyan
      shell: pwsh
      
    - name: Create build metadata
      run: |
        $buildPath = "build\${{ matrix.platform }}\${{ matrix.configuration }}"
        
        $metadata = @"
        {
          "project": "${{ env.PROJECT_NAME }}",
          "version": "${{ steps.version.outputs.version }}",
          "commit": "${{ steps.version.outputs.commit }}",
          "branch": "${{ github.ref_name }}",
          "platform": "${{ matrix.platform }}",
          "configuration": "${{ matrix.configuration }}",
          "windows_sdk": "${{ steps.sdk_setup.outputs.SDK_VERSION }}",
          "platform_toolset": "v143",
          "build_date": "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')",
          "workflow_run": "${{ github.run_number }}",
          "triggered_by": "${{ github.actor }}"
        }
        "@
        
        $metadata | Out-File -FilePath "$buildPath\build-metadata.json" -Encoding UTF8
        
        $readmeContent = @"
        # ${{ env.PROJECT_NAME }} Build
        
        **Version:** ${{ steps.version.outputs.version }}  
        **Commit:** ${{ steps.version.outputs.commit }}  
        **Branch:** ${{ github.ref_name }}  
        **Platform:** ${{ matrix.platform }}  
        **Configuration:** ${{ matrix.configuration }}  
        **Windows SDK:** ${{ steps.sdk_setup.outputs.SDK_VERSION }}  
        **Build Date:** $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')  
        
        ## Commit Message
        ${{ steps.version.outputs.commit_msg }}
        
        ## Build Information
        - Workflow Run: #${{ github.run_number }}
        - Triggered by: ${{ github.actor }}
        - Runner OS: Windows
        - Platform Toolset: v143 (Visual Studio 2022)
        
        ## Files Included
        "@ 
        
        Get-ChildItem $buildPath -File | ForEach-Object {
          $readmeContent += "`n- $($_.Name) ($([math]::Round($_.Length / 1KB, 2)) KB)"
        }
        
        $readmeContent | Out-File -FilePath "$buildPath\README.md" -Encoding UTF8
      shell: pwsh
      
    - name: Cache build artifacts
      uses: actions/cache/save@v4
      id: cache-build
      with:
        path: build/${{ matrix.platform }}/${{ matrix.configuration }}
        key: build-${{ runner.os }}-${{ matrix.platform }}-${{ matrix.configuration }}-${{ github.sha }}-${{ steps.version.outputs.version }}
        
    - name: Upload artifacts to GitHub
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PROJECT_NAME }}-${{ matrix.platform }}-${{ matrix.configuration }}-${{ steps.version.outputs.version }}
        path: |
          build/${{ matrix.platform }}/${{ matrix.configuration }}/*.exe
          build/${{ matrix.platform }}/${{ matrix.configuration }}/*.dll
          build/${{ matrix.platform }}/${{ matrix.configuration }}/*.pdb
          build/${{ matrix.platform }}/${{ matrix.configuration }}/build-metadata.json
          build/${{ matrix.platform }}/${{ matrix.configuration }}/README.md
        retention-days: 30
        if-no-files-found: error
        
  package-release:
    name: Create release package
    needs: build
    runs-on: windows-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/'))
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Get version
      id: version
      run: |
        if ("${{ github.ref }}" -match "refs/tags/v(.+)") {
          $version = $matches[1]
        } else {
          $version = (Get-Date -Format "yyyy.MM.dd.HHmm")
        }
        echo "version=$version" >> $env:GITHUB_OUTPUT
        $commitShort = "${{ github.sha }}".Substring(0,7)
        echo "commit=$commitShort" >> $env:GITHUB_OUTPUT
      shell: pwsh
      
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        
    - name: Create release packages
      run: |
        $version = "${{ steps.version.outputs.version }}"
        
        Write-Host "===== Creating Release Packages =====" -ForegroundColor Cyan
        
        # 为每个平台创建压缩包
        Get-ChildItem artifacts -Directory | ForEach-Object {
          $artifactName = $_.Name
          $zipName = "$artifactName.zip"
          
          Compress-Archive -Path "$($_.FullName)\*" -DestinationPath $zipName -Force
          
          $zipSize = [math]::Round((Get-Item $zipName).Length / 1MB, 2)
          Write-Host "  ✓ Created: $zipName ($zipSize MB)" -ForegroundColor Green
        }
        
        # 创建完整包
        $fullPackageName = "${{ env.PROJECT_NAME }}-Complete-v$version.zip"
        Compress-Archive -Path "artifacts\*" -DestinationPath $fullPackageName -Force
        
        $fullSize = [math]::Round((Get-Item $fullPackageName).Length / 1MB, 2)
        Write-Host "  ✓ Created: $fullPackageName ($fullSize MB)" -ForegroundColor Green
        
        Write-Host "=====================================" -ForegroundColor Cyan
      shell: pwsh
      
    - name: Upload release packages
      uses: actions/upload-artifact@v4
      with:
        name: release-packages-${{ steps.version.outputs.version }}
        path: "*.zip"
        retention-days: 90
        
    - name: Cache release packages
      uses: actions/cache/save@v4
      with:
        path: "*.zip"
        key: release-${{ runner.os }}-${{ steps.version.outputs.version }}-${{ github.sha }}
        
  create-github-release:
    name: Create GitHub Release
    needs: [build, package-release]
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    
    steps:
    - name: Get version
      id: version
      run: |
        $version = "${{ github.ref }}".Replace('refs/tags/v', '')
        echo "version=$version" >> $env:GITHUB_OUTPUT
      shell: pwsh
      
    - name: Download release packages
      uses: actions/download-artifact@v4
      with:
        name: release-packages-${{ steps.version.outputs.version }}
        path: release-packages
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: Release v${{ steps.version.outputs.version }}
        body: |
          ## WeChatRecorder v${{ steps.version.outputs.version }}
          
          ### Changes
          See commit history for details.
          
          ### Downloads
          - **x64 Release** - For 64-bit Windows systems (Recommended)
          - **x86 Release** - For 32-bit Windows systems
          - **Complete Package** - All builds included
          
          ### Installation
          1. Download the appropriate package for your system
          2. Extract the ZIP file
          3. Run WeChatRecorder.exe
          
          ### Requirements
          - Windows 7 or later
          - Visual C++ Redistributable (may be required)
          
          ### Build Information
          - Built with Visual Studio 2022 (v143)
          - Compatible with latest Windows SDK
          - Built with GitHub Actions
        files: |
          release-packages/*.zip
        draft: false
        prerelease: false