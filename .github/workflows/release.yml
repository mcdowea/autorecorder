name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # å½“æ¨é€ç±»ä¼¼ v1.0.0 çš„æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        targets: x86_64-pc-windows-msvc
        components: rustfmt, clippy

    # ä½¿ç”¨ Swatinem çš„ Rust ç¼“å­˜ actionï¼Œè‡ªåŠ¨ç®¡ç†æ‰€æœ‰ç¼“å­˜
    - name: Setup Rust cache
      uses: Swatinem/rust-cache@v2
      with:
        # ç¼“å­˜é”®çš„å‰ç¼€
        prefix-key: "v1-rust"
        # ç¼“å­˜ç›®æ ‡ç›®å½•
        cache-targets: true
        # ç¼“å­˜ cargo registry
        cache-on-failure: true
        # å·¥ä½œç›®å½•
        workspaces: "."

    # æ£€æŸ¥ä»£ç æ ¼å¼ï¼ˆå¯é€‰ï¼Œç”¨äº CIï¼‰
    - name: Check code format
      run: cargo fmt --all -- --check
      continue-on-error: true

    # ä½¿ç”¨å¢é‡ç¼–è¯‘åŠ é€Ÿ
    - name: Build workspace (check only)
      run: cargo check --release --workspace
      env:
        CARGO_INCREMENTAL: 1

    # å¹¶è¡Œæ„å»ºä¸¤ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶
    - name: Build CLI and GUI (Release)
      run: |
        cargo build --release --bin smart-recorder --bin smart-recorder-gui
      env:
        CARGO_INCREMENTAL: 1
        # ä½¿ç”¨æ›´å¤š CPU æ ¸å¿ƒ
        CARGO_BUILD_JOBS: 4

    - name: Verify binaries
      shell: powershell
      run: |
        if (!(Test-Path "target\release\smart-recorder.exe")) {
          Write-Error "CLI binary not found"
          exit 1
        }
        if (!(Test-Path "target\release\smart-recorder-gui.exe")) {
          Write-Error "GUI binary not found"
          exit 1
        }
        Write-Host "âœ… Both binaries built successfully"
        
        # æ˜¾ç¤ºæ–‡ä»¶å¤§å°
        $cli = Get-Item "target\release\smart-recorder.exe"
        $gui = Get-Item "target\release\smart-recorder-gui.exe"
        Write-Host "CLI size: $([math]::Round($cli.Length/1MB, 2)) MB"
        Write-Host "GUI size: $([math]::Round($gui.Length/1MB, 2)) MB"

    - name: Prepare release artifacts
      shell: powershell
      run: |
        New-Item -ItemType Directory -Force -Path release
        Copy-Item target\release\smart-recorder.exe release\
        Copy-Item target\release\smart-recorder-gui.exe release\
        Copy-Item README.md release\
        Copy-Item CONFIG.md release\ -ErrorAction SilentlyContinue
        Copy-Item QUICKSTART.md release\ -ErrorAction SilentlyContinue
        Copy-Item CHANGELOG.md release\ -ErrorAction SilentlyContinue
        
        # åˆ›å»ºé…ç½®æ–‡ä»¶ç¤ºä¾‹
        @"
        {
          "output_path": "D:\\Recordings",
          "auto_create_folders": true,
          "sample_rate": 48000,
          "bit_rate": 128,
          "audio_format": "mp3",
          "mp3_quality": 2,
          "mic_gain": 1.0,
          "speaker_gain": 1.0,
          "blacklist": "chrome.exe,firefox.exe,msedge.exe,explorer.exe",
          "auto_start": false,
          "minimize_to_tray": true,
          "min_duration_seconds": 3
        }
        "@ | Out-File -FilePath release\config.example.json -Encoding UTF8

    - name: Create ZIP archive
      shell: powershell
      run: |
        $version = "${{ github.ref_name }}"
        if ($version -notmatch "^v") {
          $version = "v1.1.0"
        }
        $zipName = "smart-recorder-windows-$version.zip"
        Compress-Archive -Path release\* -DestinationPath $zipName -Force
        Write-Host "âœ… Created $zipName"
        
        # æ˜¾ç¤º ZIP æ–‡ä»¶å¤§å°
        $zip = Get-Item $zipName
        Write-Host "ZIP size: $([math]::Round($zip.Length/1MB, 2)) MB"

    - name: Get version from tag
      id: get_version
      shell: bash
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=v1.1.0" >> $GITHUB_OUTPUT
        fi

    - name: Create Release
      uses: softprops/action-gh-release@v2
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          smart-recorder-windows-*.zip
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## Smart Recorder ${{ steps.get_version.outputs.VERSION }}
          
          ### âœ¨ æ–°åŠŸèƒ½
          - ğŸ™ï¸ **æ‰‹åŠ¨å½•éŸ³**: ç‹¬ç«‹çš„æ‰‹åŠ¨å½•éŸ³åŠŸèƒ½ï¼Œä¸ä¾èµ–éº¦å…‹é£æ£€æµ‹
          - ğŸµ **æ‰©å±•éŸ³è´¨é€‰é¡¹**: æ”¯æŒ 16kHz - 96kHz é‡‡æ ·ç‡
          - ğŸ’¿ **æ›´å¤šæ¯”ç‰¹ç‡**: æ”¯æŒ 64 - 320 kbps (6ä¸ªé€‰é¡¹)
          - âš™ï¸ **MP3 è´¨é‡æ§åˆ¶**: å¯è°ƒèŠ‚ LAME ç¼–ç è´¨é‡ (0-9)
          - ğŸ¤ **æ™ºèƒ½æ£€æµ‹**: è‡ªåŠ¨æ£€æµ‹éº¦å…‹é£ä½¿ç”¨å¹¶å½•éŸ³
          - ğŸ”Š **åŒé€šé“å½•éŸ³**: åŒæ—¶å½•åˆ¶éº¦å…‹é£å’Œæ‰¬å£°å™¨
          - ğŸš« **è¿›ç¨‹é»‘åå•**: è¿‡æ»¤ä¸éœ€è¦å½•éŸ³çš„åº”ç”¨
          - ğŸ“Š **å®æ—¶ç›‘æ§**: å¯è§†åŒ–éŸ³é¢‘ç”µå¹³æ˜¾ç¤º
          
          ### ğŸ“¥ ä¸‹è½½å’Œå®‰è£…
          
          1. ä¸‹è½½ `smart-recorder-windows-${{ steps.get_version.outputs.VERSION }}.zip`
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. è¿è¡Œ `smart-recorder-gui.exe` (æ¨èå›¾å½¢ç•Œé¢)
          4. æˆ–è¿è¡Œ `smart-recorder.exe` (å‘½ä»¤è¡Œç‰ˆæœ¬)
          
          ### ğŸ’¡ å¿«é€Ÿå¼€å§‹
          
          **è‡ªåŠ¨å½•éŸ³æ¨¡å¼**:
          - ç‚¹å‡» "â–¶ï¸ å¼€å§‹ç›‘æ§"
          - ç¨‹åºè‡ªåŠ¨æ£€æµ‹éº¦å…‹é£ä½¿ç”¨å¹¶å½•éŸ³
          - æ”¯æŒ QQã€å¾®ä¿¡ã€Zoom ç­‰æ‰€æœ‰åº”ç”¨
          
          **æ‰‹åŠ¨å½•éŸ³æ¨¡å¼**:
          - ç‚¹å‡» "ğŸ™ï¸ æ‰‹åŠ¨å½•éŸ³"
          - éšæ—¶å¼€å§‹/åœæ­¢å½•éŸ³
          - é€‚åˆå½•åˆ¶è¯¾ç¨‹ã€æ’­å®¢ç­‰
          
          ### âš™ï¸ æ¨èé…ç½®
          
          **æ—¥å¸¸å½•éŸ³**: 48kHz, 128kbps, MP3, è´¨é‡2  
          **é«˜è´¨é‡ä¼šè®®**: 48kHz, 192kbps, MP3, è´¨é‡2  
          **ä¸“ä¸šå½•éŸ³**: 96kHz, WAV æ ¼å¼ (æ— æŸ)  
          **èŠ‚çœç©ºé—´**: 22kHz, 96kbps, MP3, è´¨é‡5  
          
          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          
          - **æ“ä½œç³»ç»Ÿ**: Windows 10/11 (64-bit)
          - **æ¡†æ¶**: .NET Framework (é€šå¸¸å·²é¢„è£…)
          - **ç£ç›˜ç©ºé—´**: çº¦ 50 MB
          - **æƒé™**: éœ€è¦éº¦å…‹é£è®¿é—®æƒé™
          
          ### ğŸ“„ é…ç½®æ–‡ä»¶
          
          é¦–æ¬¡è¿è¡Œåä¼šåœ¨ç¨‹åºç›®å½•ç”Ÿæˆ `smart_recorder_config.json` é…ç½®æ–‡ä»¶ã€‚
          å¯ä»¥æ‰‹åŠ¨ç¼–è¾‘æˆ–é€šè¿‡ GUI è®¾ç½®ç•Œé¢ä¿®æ”¹ã€‚
          
          ### ğŸ› é—®é¢˜åé¦ˆ
          
          å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æäº¤ [Issue](https://github.com/${{ github.repository }}/issues)
          
          ### ğŸ“š æ–‡æ¡£
          
          - ğŸ“– [å¿«é€Ÿå…¥é—¨](https://github.com/${{ github.repository }}/blob/main/QUICKSTART.md)
          - âš™ï¸ [é…ç½®è¯´æ˜](https://github.com/${{ github.repository }}/blob/main/CONFIG.md)
          - ğŸ“ [æ›´æ–°æ—¥å¿—](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: smart-recorder-windows-${{ steps.get_version.outputs.VERSION }}
        path: smart-recorder-windows-*.zip
        retention-days: 90
        compression-level: 0  # æ–‡ä»¶å·²ç»æ˜¯ ZIPï¼Œä¸éœ€è¦å†å‹ç¼©
