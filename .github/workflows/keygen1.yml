# æ•´åˆç‰ˆï¼šæ¨ä»£ç è‡ªåŠ¨æ‰“v*è¯­ä¹‰åŒ–æ ‡ç­¾ â†’ è‡ªåŠ¨æ„å»º â†’ è‡ªåŠ¨å‘å¸ƒRelease
name: Auto Tag, Build and Release

# è§¦å‘æ¡ä»¶ï¼š
# 1. å‘mainåˆ†æ”¯æ¨ä»£ç  â†’ è§¦å‘è‡ªåŠ¨æ‰“æ ‡ç­¾
# 2. æ¨é€v*æ ¼å¼æ ‡ç­¾ â†’ è§¦å‘æ„å»ºå’ŒReleaseå‘å¸ƒï¼ˆè‡ªåŠ¨æ‰“æ ‡ç­¾åä¼šè‡ªåŠ¨è§¦å‘æ­¤è§„åˆ™ï¼‰
# 3. æ‰‹åŠ¨è§¦å‘ â†’ å¯æŒ‰éœ€è¿è¡Œ
on:
  push:
    branches: [main]          
    tags: ['v*']              
    tags-ignore: ['v*']       
  workflow_dispatch:          

# å…¨å±€æƒé™é…ç½®ï¼šè§£å†³403ï¼Œèµ‹äºˆå†™æ ‡ç­¾/Releaseæƒé™
permissions:
  contents: write
  pull-requests: read

jobs:
  # Job1ï¼šè‡ªåŠ¨æ‰“v*è¯­ä¹‰åŒ–æ ‡ç­¾ï¼ˆä»…æ¨mainåˆ†æ”¯æ—¶è¿è¡Œï¼‰
  auto-tag:
    if: github.ref_type == 'branch' && github.ref_name == 'main'
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»“åº“ä»£ç ï¼ˆéœ€æ‹‰å–æ‰€æœ‰æäº¤è®°å½•ï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  

      - name: è‡ªåŠ¨ç”Ÿæˆv*æ ¼å¼è¯­ä¹‰åŒ–æ ‡ç­¾
        uses: anothrNick/github-tag-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GIT_TOKEN }}
          DEFAULT_BUMP: patch                        
          TAG_PREFIX: v                              
          RELEASE_BRANCHES: main                     
          VERBOSE: true                              

  # Job2ï¼šæ„å»ºé¡¹ç›®å¹¶å‘å¸ƒReleaseï¼ˆä»…æ¨é€v*æ ‡ç­¾æ—¶è¿è¡Œï¼‰
  build-release:
    if: github.ref_type == 'tag' && startsWith(github.ref_name, 'v')
    runs-on: windows-latest
    needs: []  
    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: é…ç½®MSBuildç¯å¢ƒï¼ˆWindowsæ„å»ºC#å¿…å¤‡ï¼‰
        uses: microsoft/setup-msbuild@v2

      - name: è¿˜åŸNuGetä¾èµ–åŒ…
        run: nuget restore WeChatRecorder.sln

      - name: æ„å»ºReleaseç‰ˆæœ¬ï¼ˆx64ï¼‰
        run: |
          chcp 65001  # è§£å†³ä¸­æ–‡ä¹±ç 
          msbuild WeChatRecorder.sln /p:Configuration=Release /p:Platform=x64

      - name: å‡†å¤‡å‘å¸ƒåŒ…æ–‡ä»¶
        run: |
          mkdir release-package
          copy x64\Release\WeChatRecorder.exe release-package\
          copy README.md release-package\
          echo "è¯·ä» https://gyan.dev/ffmpeg/builds/ ä¸‹è½½ FFmpeg å¹¶å°† ffmpeg.exe æ”¾ç½®åœ¨åŒä¸€ç›®å½•ä¸‹" > release-package\FFMPEG_README.txt
        shell: cmd

      - name: å‹ç¼©å‘å¸ƒåŒ…ä¸ºZIP
        run: Compress-Archive -Path release-package\* -DestinationPath WeChatRecorder-Release.zip
        shell: powershell

      # ã€æ ¸å¿ƒä¿®æ”¹ï¼šæ›¿æ¢ä¸ºæ–°ç‰ˆActionï¼Œåˆå¹¶åˆ›å»ºRelease+ä¸Šä¼ æ‰€æœ‰èµ„äº§ï¼Œè§£å†³draft/prereleaseæŠ¥é”™ã€‘
      - name: åˆ›å»ºReleaseå¹¶ä¸Šä¼ ZIP/EXEèµ„äº§
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GIT_TOKEN }}
        with:
          name: Release ${{ github.ref_name }}  # å‘å¸ƒåç§°ï¼Œå¦‚Release v0.0.1
          body: |
            ## WeChatRecorder - å¾®ä¿¡å½•éŸ³è‡ªåŠ¨æ‹¾éŸ³å·¥å…·
            
            ### ğŸ“¦ å®‰è£…è¯´æ˜
            1. ä¸‹è½½ `WeChatRecorder-Release.zip` å¹¶è§£å‹
            2. ä» [gyan.dev](https://gyan.dev/ffmpeg/builds/) ä¸‹è½½ FFmpegï¼ˆæ¨èfull/essentialsç‰ˆæœ¬ï¼‰
            3. å°† `ffmpeg.exe` æ”¾åœ¨ä¸ `WeChatRecorder.exe` ç›¸åŒç›®å½•ä¸‹
            4. ç›´æ¥è¿è¡Œ `WeChatRecorder.exe`
            
            ### âœ¨ åŠŸèƒ½ç‰¹æ€§
            - æ˜¾ç¤ºå½•éŸ³æ—¶é•¿å’Œæ–‡ä»¶å¤§å°
            - æ”¯æŒæ‰‹åŠ¨/è‡ªåŠ¨å½•éŸ³
            - ä¼˜åŒ–çš„å¯è§†åŒ–ç”¨æˆ·ç•Œé¢
            - ä¸€é”®æ‰“å¼€å½•éŸ³æ–‡ä»¶æ‰€åœ¨æ–‡ä»¶å¤¹
            
            ### âš ï¸ æ³¨æ„äº‹é¡¹
            - é€‚ç”¨ç³»ç»Ÿï¼šWindows Vista åŠä»¥ä¸Šç‰ˆæœ¬
            - å¿…é¡»å®‰è£…åŒ…å« libmp3lame ç¼–ç å™¨çš„ FFmpeg
          draft: false  # ç›´æ¥å¹³çº§å†™ï¼Œæ— æ ¼å¼æŠ¥é”™
          prerelease: false  # ç›´æ¥å¹³çº§å†™ï¼Œæ— æ ¼å¼æŠ¥é”™
          # ä¸€æ¬¡æ€§ä¸Šä¼ æ‰€æœ‰éœ€è¦çš„èµ„äº§ï¼Œæ— éœ€å¤šæ¬¡è°ƒç”¨Action
          files:
            - WeChatRecorder-Release.zip
            - x64/Release/WeChatRecorder.exe