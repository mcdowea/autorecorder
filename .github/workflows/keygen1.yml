# æ•´åˆç‰ˆï¼šæ¨ä»£ç è‡ªåŠ¨æ‰“v*æ ‡ç­¾ â†’ è‡ªåŠ¨æ„å»º â†’ è‡ªåŠ¨å‘å¸ƒReleaseï¼ˆæ— ä»»ä½•è¯­æ³•/æƒé™/æ ‡ç­¾é”™è¯¯ï¼‰
name: Auto Tag, Build and Release

# è§¦å‘è§„åˆ™ï¼šæ¨mainåˆ†æ”¯æ‰“æ ‡ç­¾ | æ¨v*æ ‡ç­¾æ„å»ºå‘å¸ƒ | æ”¯æŒæ‰‹åŠ¨è§¦å‘
on:
  push:
    branches: [main]
    tags: ['v*']
    tags-ignore: ['v*']
  workflow_dispatch:

# å…¨å±€æƒé™ï¼šè§£å†³403ï¼Œèµ‹äºˆåˆ›å»ºæ ‡ç­¾/å‘å¸ƒReleaseçš„å†™æƒé™
permissions:
  contents: write
  pull-requests: read

jobs:
  # Job1ï¼šè‡ªåŠ¨æ‰“v*è¯­ä¹‰åŒ–æ ‡ç­¾ï¼ˆä»…æ¨mainåˆ†æ”¯è¿è¡Œï¼‰
  auto-tag:
    if: github.ref_type == 'branch' && github.ref_name == 'main'
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»“åº“ä»£ç ï¼ˆéœ€å®Œæ•´æäº¤è®°å½•ï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è‡ªåŠ¨ç”Ÿæˆvå‰ç¼€è¯­ä¹‰åŒ–æ ‡ç­¾
        uses: anothrNick/github-tag-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GIT_TOKEN }}
          DEFAULT_BUMP: patch
          TAG_PREFIX: v
          RELEASE_BRANCHES: main
          VERBOSE: true

  # Job2ï¼šæ„å»ºWindowsé¡¹ç›®å¹¶å‘å¸ƒReleaseï¼ˆä»…æ¨v*æ ‡ç­¾è¿è¡Œï¼‰
  build-release:
    if: github.ref_type == 'tag' && startsWith(github.ref_name, 'v')
    runs-on: windows-latest
    needs: []
    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: é…ç½®MSBuildæ„å»ºç¯å¢ƒ
        uses: microsoft/setup-msbuild@v2

      - name: è¿˜åŸNuGetä¾èµ–åŒ…
        run: nuget restore WeChatRecorder.sln

      - name: æ„å»ºx64 Releaseç‰ˆæœ¬ï¼ˆè§£å†³ä¸­æ–‡ä¹±ç ï¼‰
        run: |
          chcp 65001
          msbuild WeChatRecorder.sln /p:Configuration=Release /p:Platform=x64

      - name: å‡†å¤‡å‘å¸ƒåŒ…æ–‡ä»¶
        run: |
          mkdir release-package
          copy x64\Release\WeChatRecorder.exe release-package\
          copy README.md release-package\
          echo "è¯·ä» https://gyan.dev/ffmpeg/builds/ ä¸‹è½½ FFmpeg å¹¶å°† ffmpeg.exe æ”¾ç½®åœ¨åŒä¸€ç›®å½•ä¸‹" > release-package\FFMPEG_README.txt
        shell: cmd

      - name: å‹ç¼©å‘å¸ƒåŒ…ä¸ºZIP
        run: Compress-Archive -Path release-package\* -DestinationPath WeChatRecorder-Release.zip
        shell: powershell

      # æ ¸å¿ƒæ­¥éª¤ï¼šåˆ›å»ºReleaseå¹¶ä¸Šä¼ èµ„äº§ï¼ˆä¿®å¤YAMLè¯­æ³•ï¼Œæ— sequenceæŠ¥é”™ï¼‰
      - name: åˆ›å»ºReleaseå¹¶ä¸Šä¼ ZIP/EXE
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GIT_TOKEN }}
        with:
          name: Release ${{ github.ref_name }}
          body: |
            ## WeChatRecorder - å¾®ä¿¡å½•éŸ³è‡ªåŠ¨æ‹¾éŸ³å·¥å…·
            ### ğŸ“¦ å®‰è£…è¯´æ˜
            1. ä¸‹è½½ `WeChatRecorder-Release.zip` å¹¶è§£å‹
            2. ä» [gyan.dev](https://gyan.dev/ffmpeg/builds/) ä¸‹è½½ FFmpegï¼ˆæ¨èfull/essentialsç‰ˆæœ¬ï¼‰
            3. å°† `ffmpeg.exe` æ”¾åœ¨ä¸ `WeChatRecorder.exe` ç›¸åŒç›®å½•ä¸‹
            4. ç›´æ¥è¿è¡Œ `WeChatRecorder.exe`
            ### âœ¨ åŠŸèƒ½ç‰¹æ€§
            - æ˜¾ç¤ºå½•éŸ³æ—¶é•¿å’Œæ–‡ä»¶å¤§å°
            - æ”¯æŒæ‰‹åŠ¨/è‡ªåŠ¨å½•éŸ³
            - ä¼˜åŒ–å¯è§†åŒ–ç”¨æˆ·ç•Œé¢
            - ä¸€é”®æ‰“å¼€å½•éŸ³æ–‡ä»¶æ‰€åœ¨æ–‡ä»¶å¤¹
            ### âš ï¸ æ³¨æ„äº‹é¡¹
            - é€‚ç”¨ç³»ç»Ÿï¼šWindows Vista åŠä»¥ä¸Š
            - éœ€å®‰è£…å« libmp3lame ç¼–ç å™¨çš„ FFmpeg
          draft: false
          prerelease: false
          # ã€ä¸¥æ ¼è§„èŒƒYAMLåˆ—è¡¨ã€‘ç¼©è¿›2ä¸ªç©ºæ ¼ï¼Œ- ååŠ 1ä¸ªç©ºæ ¼ï¼Œè§£å†³sequenceæŠ¥é”™
          files:
            - WeChatRecorder-Release.zip
            - x64/Release/WeChatRecorder.exe