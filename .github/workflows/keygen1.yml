# æ•´åˆç‰ˆï¼šæ¨ä»£ç è‡ªåŠ¨æ‰“v*è¯­ä¹‰åŒ–æ ‡ç­¾ â†’ è‡ªåŠ¨æ„å»º â†’ è‡ªåŠ¨å‘å¸ƒRelease
name: Auto Tag, Build and Release

# è§¦å‘æ¡ä»¶ï¼š
# 1. å‘mainåˆ†æ”¯æ¨ä»£ç  â†’ è§¦å‘è‡ªåŠ¨æ‰“æ ‡ç­¾
# 2. æ¨é€v*æ ¼å¼æ ‡ç­¾ â†’ è§¦å‘æ„å»ºå’ŒReleaseå‘å¸ƒï¼ˆè‡ªåŠ¨æ‰“æ ‡ç­¾åä¼šè‡ªåŠ¨è§¦å‘æ­¤è§„åˆ™ï¼‰
# 3. æ‰‹åŠ¨è§¦å‘ â†’ å¯æŒ‰éœ€è¿è¡Œæ‰“æ ‡ç­¾/æ„å»ºå‘å¸ƒ
on:
  push:
    branches: [main]          # æ¨mainåˆ†æ”¯ï¼šä»…è¿è¡Œã€è‡ªåŠ¨æ‰“æ ‡ç­¾ã€‘job
    tags: ['v*']              # æ¨v*æ ‡ç­¾ï¼šä»…è¿è¡Œã€æ„å»ºå‘å¸ƒã€‘job
    tags-ignore: ['v*']       # æ’é™¤æ ‡ç­¾æ¨é€å¯¹åˆ†æ”¯çš„è§¦å‘ï¼Œé¿å…å¾ªç¯
  workflow_dispatch:          # æ‰‹åŠ¨è§¦å‘ï¼šå¯é€‰æ‹©è¿è¡Œä»»æ„jobï¼ˆé»˜è®¤å…¨è¿è¡Œï¼‰

# å…¨å±€æƒé™é…ç½®ï¼šè§£å†³403é”™è¯¯ï¼Œèµ‹äºˆGITHUB_TOKENå¿…è¦çš„å†™æƒé™
# contents: write â†’ å…è®¸åˆ›å»ºæ ‡ç­¾ã€æ¨é€æ ‡ç­¾ã€åˆ›å»ºReleaseã€ä¸Šä¼ èµ„äº§
# pull-requests: read â†’ è§„èŒƒé…ç½®ï¼Œéå¿…é¡»
permissions:
  contents: write
  pull-requests: read

jobs:
  # Job1ï¼šè‡ªåŠ¨æ‰“v*è¯­ä¹‰åŒ–æ ‡ç­¾ï¼ˆä»…æ¨mainåˆ†æ”¯æ—¶è¿è¡Œï¼Œæ ‡ç­¾æ¨é€åè‡ªåŠ¨è§¦å‘Job2ï¼‰
  auto-tag:
    # æ¡ä»¶æ§åˆ¶ï¼šä»…å½“è§¦å‘æºæ˜¯ã€æ¨mainåˆ†æ”¯ã€‘æ—¶è¿è¡Œï¼Œæ¨æ ‡ç­¾/æ‰‹åŠ¨è§¦å‘ä¸è¿è¡Œ
    if: github.ref_type == 'branch' && github.ref_name == 'main'
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»“åº“ä»£ç ï¼ˆéœ€æ‹‰å–æ‰€æœ‰æäº¤è®°å½•ï¼Œç”¨äºç‰ˆæœ¬åˆ¤æ–­ï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å¿…é¡»è®¾ä¸º0ï¼Œå¦åˆ™æ— æ³•è·å–å†å²æäº¤åˆ¤æ–­ç‰ˆæœ¬å‡çº§

      - name: è‡ªåŠ¨ç”Ÿæˆv*æ ¼å¼è¯­ä¹‰åŒ–æ ‡ç­¾
        uses: anothrNick/github-tag-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # ç”¨GitHubå†…ç½®ä»¤ç‰Œï¼Œæ— éœ€æ‰‹åŠ¨åˆ›å»ºGIT_TOKEN
          DEFAULT_BUMP: patch                        # é»˜è®¤è¡¥ä¸æ›´æ–°ï¼ˆv0.0.1â†’v0.0.2ï¼‰
          TAG_PREFIX: v                              # å›ºå®šæ ‡ç­¾å‰ç¼€ä¸ºvï¼Œå’Œæ„å»ºå‘å¸ƒçš„è§¦å‘è§„åˆ™åŒ¹é…
          RELEASE_BRANCHES: main                     # ä»…åœ¨mainåˆ†æ”¯è§¦å‘è‡ªåŠ¨æ‰“æ ‡ç­¾
          VERBOSE: true                              # è¾“å‡ºè¯¦ç»†æ—¥å¿—ï¼Œæ–¹ä¾¿æ’æŸ¥é—®é¢˜
          # æäº¤ä¿¡æ¯å…³é”®å­—å¯¹åº”ç‰ˆæœ¬å‡çº§ï¼ˆè¡Œä¸šè¯­ä¹‰åŒ–è§„èŒƒï¼Œæ— éœ€ä¿®æ”¹ï¼‰
          # feat: xxx â†’ minorå°ç‰ˆæœ¬ï¼ˆv0.0.1â†’v0.1.0ï¼‰
          # fix!/BREAKING CHANGE â†’ majorå¤§ç‰ˆæœ¬ï¼ˆv0.1.0â†’v1.0.0ï¼‰
          # å…¶ä»–ï¼ˆfix:/docs:/ci:ï¼‰â†’ patchè¡¥ä¸ç‰ˆæœ¬

  # Job2ï¼šæ„å»ºé¡¹ç›®å¹¶å‘å¸ƒReleaseï¼ˆä»…æ¨é€v*æ ‡ç­¾æ—¶è¿è¡Œï¼Œè‡ªåŠ¨æ‰“æ ‡ç­¾åä¼šè‡ªåŠ¨è§¦å‘ï¼‰
  build-release:
    # æ¡ä»¶æ§åˆ¶ï¼šä»…å½“è§¦å‘æºæ˜¯ã€æ¨v*æ ‡ç­¾ã€‘æ—¶è¿è¡Œï¼Œæ¨åˆ†æ”¯/æ‰‹åŠ¨è§¦å‘å¯æŒ‰éœ€å–æ¶ˆ
    if: github.ref_type == 'tag' && startsWith(github.ref_name, 'v')
    runs-on: windows-latest
    needs: []  # ä¸ä¾èµ–auto-tagï¼Œå› ä¸ºæ ‡ç­¾æ¨é€æ˜¯ç‹¬ç«‹è§¦å‘ï¼Œé¿å…æ‰‹åŠ¨æ‰“æ ‡ç­¾æ—¶ç­‰å¾…
    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: é…ç½®MSBuildç¯å¢ƒï¼ˆWindowsæ„å»ºC#å¿…å¤‡ï¼‰
        uses: microsoft/setup-msbuild@v2

      - name: è¿˜åŸNuGetä¾èµ–åŒ…
        run: nuget restore WeChatRecorder.sln

      - name: æ„å»ºReleaseç‰ˆæœ¬ï¼ˆx64ï¼‰
        run: |
          chcp 65001  # è§£å†³ä¸­æ–‡ä¹±ç 
          msbuild WeChatRecorder.sln /p:Configuration=Release /p:Platform=x64

      - name: å‡†å¤‡å‘å¸ƒåŒ…æ–‡ä»¶
        run: |
          mkdir release-package
          copy x64\Release\WeChatRecorder.exe release-package\
          copy README.md release-package\
          echo "è¯·ä» https://gyan.dev/ffmpeg/builds/ ä¸‹è½½ FFmpeg å¹¶å°† ffmpeg.exe æ”¾ç½®åœ¨åŒä¸€ç›®å½•ä¸‹" > release-package\FFMPEG_README.txt
        shell: cmd

      - name: å‹ç¼©å‘å¸ƒåŒ…ä¸ºZIP
        run: Compress-Archive -Path release-package\* -DestinationPath WeChatRecorder-Release.zip
        shell: powershell

      - name: åˆ›å»ºGitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}  # ä¿®å¤ï¼šç”¨çº¯æ ‡ç­¾åï¼ˆå¦‚v0.0.1ï¼‰ï¼Œæ›¿ä»£å¸¦è·¯å¾„çš„github.ref
          release_name: Release ${{ github.ref_name }}  # å‘å¸ƒåç§°ï¼Œå¦‚Release v0.0.1
          body: |
            ## WeChatRecorder - å¾®ä¿¡å½•éŸ³è‡ªåŠ¨æ‹¾éŸ³å·¥å…·
            
            ### ğŸ“¦ å®‰è£…è¯´æ˜
            1. ä¸‹è½½ `WeChatRecorder-Release.zip` å¹¶è§£å‹
            2. ä» [gyan.dev](https://gyan.dev/ffmpeg/builds/) ä¸‹è½½ FFmpegï¼ˆæ¨èfull/essentialsç‰ˆæœ¬ï¼‰
            3. å°† `ffmpeg.exe` æ”¾åœ¨ä¸ `WeChatRecorder.exe` ç›¸åŒç›®å½•ä¸‹
            4. ç›´æ¥è¿è¡Œ `WeChatRecorder.exe`
            
            ### âœ¨ åŠŸèƒ½ç‰¹æ€§
            - æ˜¾ç¤ºå½•éŸ³æ—¶é•¿å’Œæ–‡ä»¶å¤§å°
            - æ”¯æŒæ‰‹åŠ¨/è‡ªåŠ¨å½•éŸ³
            - ä¼˜åŒ–çš„å¯è§†åŒ–ç”¨æˆ·ç•Œé¢
            - ä¸€é”®æ‰“å¼€å½•éŸ³æ–‡ä»¶æ‰€åœ¨æ–‡ä»¶å¤¹
            
            ### âš ï¸ æ³¨æ„äº‹é¡¹
            - é€‚ç”¨ç³»ç»Ÿï¼šWindows Vista åŠä»¥ä¸Šç‰ˆæœ¬
            - å¿…é¡»å®‰è£…åŒ…å« libmp3lame ç¼–ç å™¨çš„ FFmpeg
        draft: false
        prerelease: false

      - name: ä¸Šä¼ ZIPå‹ç¼©åŒ…åˆ°Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./WeChatRecorder-Release.zip
          asset_name: WeChatRecorder-Release.zip
          asset_content_type: application/zip

      - name: ä¸Šä¼ å•ç‹¬çš„EXEæ–‡ä»¶åˆ°Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./x64/Release/WeChatRecorder.exe
          asset_name: WeChatRecorder.exe
          asset_content_type: application/octet-stream