name: Advanced Build and Cache

on:
  push:
    branches: [ main, master, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'Release'
        type: choice
        options:
          - Debug
          - Release

# é€‚é…slnçš„ç›®å½•ç»“æ„ï¼Œä¿®æ­£é¡¹ç›®/è§£å†³æ–¹æ¡ˆè·¯å¾„ã€å¹³å°æ˜ å°„
env:
  PROJECT_NAME: WeChatRecorder
  SOLUTION_NAME: WeChatRecorder.sln # æ ¹ç›®å½•çš„slnï¼Œä¸å®é™…ä¸€è‡´
  PROJECT_PROJ_PATH: WeChatRecorder/WeChatRecorder.vcxproj # slnä¸­å®é™…çš„vcxprojè·¯å¾„
  BUILD_ROOT: ${{ github.workspace }}/build # æ„å»ºæ ¹ç›®å½•ï¼Œç»Ÿä¸€ç®¡ç†

jobs:
  build:
    name: Build ${{ matrix.platform }} - ${{ matrix.configuration }}
    runs-on: windows-latest
    strategy:
      matrix:
        # ä¸slnçš„SolutionConfigurationPlatformså®Œå…¨ä¸€è‡´ï¼šx64ã€Win32ï¼ˆå¯¹åº”slnçš„x86ï¼‰
        platform: [x64, Win32]
        configuration: [Release, Debug]
        exclude:
          - platform: Win32
            configuration: Debug # ä¿ç•™åŸä¼˜åŒ–ï¼ŒèŠ‚çœæ„å»ºæ—¶é—´

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      with:
        vs-version: '17.14' # ä¸slnçš„VisualStudioVersion 17.14ç²¾å‡†åŒ¹é…ï¼Œé¿å…å…¼å®¹é—®é¢˜
        msbuild-architecture: x64

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2

    - name: Restore dependencies
      run: nuget restore ${{ env.SOLUTION_NAME }} # ç›´æ¥è¿˜åŸslnï¼Œè‡ªåŠ¨è¯†åˆ«å­é¡¹ç›®ä¾èµ–ï¼Œæœ€å¯é 

    - name: Create build directory
      run: New-Item -Path ${{ env.BUILD_ROOT }} -ItemType Directory -Force
      shell: pwsh # ç¡®ä¿æ„å»ºè¾“å‡ºç›®å½•å­˜åœ¨ï¼Œé¿å…MSBuildè·¯å¾„æŠ¥é”™

    - name: Get version information
      id: version
      run: |
        if ("${{ github.ref }}" -match "refs/tags/v(.+)") {
          $version = $matches[1]
        } else {
          $version = (Get-Date -Format "yyyy.MM.dd.HHmm")
        }
        $commitShort = "${{ github.sha }}".Substring(0,7)
        $commitMsg = git log -1 --pretty=%B | Out-String | Trim # å»é™¤æäº¤ä¿¡æ¯å¤šä½™æ¢è¡Œï¼Œé¿å…JSON/MDä¹±ç 

        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "commit=$commitShort" >> $env:GITHUB_OUTPUT
        echo "commit_msg=$commitMsg" >> $env:GITHUB_OUTPUT

        Write-Host "Version: $version" -ForegroundColor Cyan
        Write-Host "Commit: $commitShort" -ForegroundColor Cyan
      shell: pwsh

    - name: Build project (é€‚é…slnå­é¡¹ç›®ç»“æ„)
      run: |
        msbuild ${{ env.PROJECT_PROJ_PATH }} `
          /p:Configuration=${{ matrix.configuration }} `
          /p:Platform=${{ matrix.platform }} `
          /p:OutDir="${{ env.BUILD_ROOT }}\${{ matrix.platform }}\${{ matrix.configuration }}\\" `
          /p:SolutionDir="${{ github.workspace }}\\" ` # å…³é”®ï¼šæŒ‡å®šè§£å†³æ–¹æ¡ˆæ ¹ç›®å½•ï¼Œè§£å†³å­é¡¹ç›®çš„ç›¸å¯¹è·¯å¾„ä¾èµ–
          /m /nologo /v:normal # /nologoéšè—å†—ä½™æ—¥å¿—ï¼Œ/v:normalä¿ç•™å…³é”®é”™è¯¯ä¿¡æ¯
      shell: pwsh

    - name: Verify build output (æ ¸å¿ƒæ ¡éªŒï¼Œå¤±è´¥æ—¶æ‰“å°ç›®å½•å†…å®¹æ’éšœ)
      run: |
        $exePath = "${{ env.BUILD_ROOT }}\${{ matrix.platform }}\${{ matrix.configuration }}\${{ env.PROJECT_NAME }}.exe"
        $buildDir = Split-Path $exePath -Parent

        # æ‰“å°ç›®å½•æ‰€æœ‰æ–‡ä»¶ï¼Œæ–¹ä¾¿æ’éšœ
        Write-Host "=== Build directory files ===" -ForegroundColor Yellow
        Get-ChildItem -Recurse $buildDir | Format-Table Name, Length, LastWriteTime -AutoSize

        if (Test-Path $exePath -PathType Leaf) {
          Write-Host "âœ“ Build successful! EXE found: $exePath" -ForegroundColor Green
          $fileInfo = Get-Item $exePath
          Write-Host "Size: $([math]::Round($fileInfo.Length / 1MB, 2)) MB | Modified: $($fileInfo.LastWriteTime)" -ForegroundColor Green
        } else {
          Write-Error "âœ— Build failed! EXE not found at: $exePath"
          exit 1
        }
      shell: pwsh

    - name: Create build metadata (JSON/MD UTF-8ç¼–ç ï¼Œé¿å…ä¹±ç )
      run: |
        $buildPath = "${{ env.BUILD_ROOT }}\${{ matrix.platform }}\${{ matrix.configuration }}"
        $buildDate = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'

        # ç”Ÿæˆå…ƒæ•°æ®JSON
        $metadata = [PSCustomObject]@{
          project = "${{ env.PROJECT_NAME }}"
          version = "${{ steps.version.outputs.version }}"
          commit = "${{ steps.version.outputs.commit }}"
          branch = "${{ github.ref_name }}"
          platform = "${{ matrix.platform }}"
          configuration = "${{ matrix.configuration }}"
          build_date = $buildDate
          workflow_run = "${{ github.run_number }}"
          triggered_by = "${{ github.actor }}"
          solution_version = "17.14"
        } | ConvertTo-Json -Depth 3
        $metadata | Out-File -FilePath "$buildPath\build-metadata.json" -Encoding utf8 -Force

        # ç”ŸæˆREADME.md
        $readmeContent = @"
# ${{ env.PROJECT_NAME }} Build
**Version:** ${{ steps.version.outputs.version }}
**Commit:** ${{ steps.version.outputs.commit }}
**Branch:** ${{ github.ref_name }}
**Platform:** ${{ matrix.platform }}
**Configuration:** ${{ matrix.configuration }}
**Build Date:** $buildDate

## Commit Message
${{ steps.version.outputs.commit_msg }}

## Build Information
- Workflow Run: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
- Triggered by: ${{ github.actor }}
- Runner OS: Windows (VS2022 17.14)
- Solution File: ${{ env.SOLUTION_NAME }}

## Files Included
"@
        # è¿½åŠ æ–‡ä»¶åˆ—è¡¨
        Get-ChildItem $buildPath -File | ForEach-Object {
          $sizeKB = [math]::Round($_.Length / 1KB, 2)
          $readmeContent += "`n- $($_.Name) ($sizeKB KB)"
        }
        $readmeContent | Out-File -FilePath "$buildPath\README.md" -Encoding utf8 -Force
      shell: pwsh

    - name: Cache build artifacts
      uses: actions/cache/save@v4
      id: cache-build
      with:
        path: ${{ env.BUILD_ROOT }}/${{ matrix.platform }}/${{ matrix.configuration }}
        key: build-${{ runner.os }}-${{ matrix.platform }}-${{ matrix.configuration }}-${{ github.sha }}-${{ steps.version.outputs.version }}

    - name: Upload artifacts to GitHub
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PROJECT_NAME }}-${{ matrix.platform }}-${{ matrix.configuration }}-${{ steps.version.outputs.version }}
        path: |
          ${{ env.BUILD_ROOT }}/${{ matrix.platform }}/${{ matrix.configuration }}/*.exe
          ${{ env.BUILD_ROOT }}/${{ matrix.platform }}/${{ matrix.configuration }}/*.dll
          ${{ env.BUILD_ROOT }}/${{ matrix.platform }}/${{ matrix.configuration }}/*.pdb
          ${{ env.BUILD_ROOT }}/${{ matrix.platform }}/${{ matrix.configuration }}/build-metadata.json
          ${{ env.BUILD_ROOT }}/${{ matrix.platform }}/${{ matrix.configuration }}/README.md
        retention-days: 30
        if-no-files-found: error # æ— æ–‡ä»¶åˆ™ç›´æ¥å¤±è´¥ï¼Œå¿«é€Ÿå‘ç°é—®é¢˜

  package-release:
    name: Create release package
    needs: build
    runs-on: windows-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/'))
    steps:
    - name: Get version
      id: version
      run: |
        if ("${{ github.ref }}" -match "refs/tags/v(.+)") {
          $version = $matches[1]
        } else {
          $version = (Get-Date -Format "yyyy.MM.dd.HHmm")
        }
        echo "version=$version" >> $env:GITHUB_OUTPUT
      shell: pwsh

    - name: Download all build artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        merge-multiple: false # ä¿æŒæ¯ä¸ªæ„å»ºäº§ç‰©çš„ç‹¬ç«‹ç›®å½•ï¼Œé¿å…æ–‡ä»¶å†²çª

    - name: Create release zip packages
      run: |
        $version = "${{ steps.version.outputs.version }}"
        # ä¸ºæ¯ä¸ªå¹³å°/é…ç½®åˆ›å»ºç‹¬ç«‹å‹ç¼©åŒ…
        Get-ChildItem artifacts -Directory | ForEach-Object {
          $zipPath = "$($_.Name).zip"
          Compress-Archive -Path "$($_.FullName)\*" -DestinationPath $zipPath -Force -CompressionLevel Optimal
          Write-Host "âœ… Created package: $zipPath ($([math]::Round((Get-Item $zipPath).Length / 1MB, 2)) MB)" -ForegroundColor Green
        }
        # åˆ›å»ºå®Œæ•´åŒ…ï¼ˆåŒ…å«æ‰€æœ‰æ„å»ºäº§ç‰©ï¼‰
        $fullPackage = "${{ env.PROJECT_NAME }}-Complete-v$version.zip"
        Compress-Archive -Path "artifacts\*" -DestinationPath $fullPackage -Force -CompressionLevel Optimal
        Write-Host "âœ… Created complete package: $fullPackage ($([math]::Round((Get-Item $fullPackage).Length / 1MB, 2)) MB)" -ForegroundColor Green
      shell: pwsh

    - name: Upload release packages
      uses: actions/upload-artifact@v4
      with:
        name: release-packages-${{ steps.version.outputs.version }}
        path: "*.zip"
        retention-days: 90

    - name: Cache release packages
      uses: actions/cache/save@v4
      with:
        path: "*.zip"
        key: release-${{ runner.os }}-${{ steps.version.outputs.version }}-${{ github.sha }}

  create-github-release:
    name: Create GitHub Release
    needs: [build, package-release]
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/v') # ä»…æ‰“tagæ—¶åˆ›å»ºæ­£å¼Release
    permissions:
      contents: write # æˆäºˆåˆ›å»ºReleaseçš„æƒé™
    steps:
    - name: Get release version
      id: version
      run: |
        $version = "${{ github.ref }}".Replace('refs/tags/v', '')
        echo "version=$version" >> $env:GITHUB_OUTPUT
      shell: pwsh

    - name: Download release packages
      uses: actions/download-artifact@v4
      with:
        name: release-packages-${{ steps.version.outputs.version }}
        path: release-packages

    - name: Create GitHub Release with assets
      uses: softprops/action-gh-release@v2 # å‡çº§åˆ°v2ï¼Œæ›´ç¨³å®šã€å…¼å®¹æœ€æ–°GitHub API
      with:
        name: WeChatRecorder v${{ steps.version.outputs.version }}
        tag_name: v${{ steps.version.outputs.version }}
        body: |
          ## WeChatRecorder v${{ steps.version.outputs.version }}
          Official build for Windows (VS2022 17.14)
          
          ### ğŸ“¥ Downloads
          - **x64 Release** (Recommended): For 64-bit Windows 7/10/11
          - **Win32 Release**: For 32-bit Windows systems
          - **Complete Package**: Contains all build variants
          
          ### ğŸ›  Installation
          1. Download the appropriate ZIP package for your system
          2. Extract the ZIP file to any directory
          3. Run `WeChatRecorder.exe` directly (no installation required)
          
          ### ğŸ“‹ Requirements
          - Windows 7 or later (x86/x64)
          - Visual C++ Redistributable for Visual Studio 2022 (included in build if needed)
          
          ### ğŸ” Build Info
          - Commit: ${{ github.sha | substr 0 7 }}
          - Build Time: ${{ github.run_at }}
          - Runner: Windows Server 2022 (VS2022 17.14)
        files: release-packages/*.zip
        draft: false
        prerelease: false
        make_latest: true # å°†æœ€æ–°tagè®¾ä¸ºæœ€æ–°Release